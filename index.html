<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bento Soundpad</title>
  <meta name="description" content="‡πÄ‡∏ß‡πá‡∏ö Soundpad ‡πÅ‡∏ö‡∏ö‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏û‡∏≤‡∏Å‡∏¢‡πå ‚Äî ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Æ‡∏≠‡∏ï‡∏Ñ‡∏µ‡∏¢‡πå/‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≠‡∏ô/‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏•‡πÇ‡∏Å‡πâ/‡∏†‡∏≤‡∏û‡∏õ‡∏Å ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å sounds.json" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#111823; --card:#0d1522; --acc:#41d1ff; --muted:#9fb3c8; --text:#e6f0ff; --ring:#2b6cb0;
      --pad-red1:#a80b0b; --pad-red2:#eb2c2c; --pad-green1:#0d6d26; --pad-green2:#35c75a; --pad-blue1:#114b7a; --pad-blue2:#2ea2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#0b0f14,#0e141d 60%,#0b0f14);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif}
    header{position:sticky;top:0;z-index:30;background:rgba(17,24,35,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #182335}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:20px;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1622;border:1px solid #1e2c43}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="search"], select, .btn{background:#0e1622;color:var(--text);border:1px solid #1e2c43;border-radius:12px;padding:10px 12px;font-size:14px}
    input[type="search"]{flex:1;min-width:180px}
    .btn{cursor:pointer;user-select:none}
    .btn:hover{border-color:#294061}
    .btn.primary{background:linear-gradient(180deg,#133250,#0e1f34);border-color:#254467}
    .btn.ghost{background:transparent;border-color:#1e2c43}
    .btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:var(--acc)}

    .hero{position:relative}
    .hero .cover{width:100%;height:180px;object-fit:cover;display:block;filter:saturate(110%);}
    .hero .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(12,18,26,.1),rgba(11,15,20,.8));}
    .hero .title{position:absolute;left:16px;bottom:14px;font-size:22px;font-weight:700;text-shadow:0 2px 10px rgba(0,0,0,.6)}

    main{max-width:1200px;margin:10px auto;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
    .tab{padding:6px 12px;border-radius:999px;border:1px solid #22314b;background:#0f1724;cursor:pointer;color:var(--muted)}
    .tab.active{color:#09121c;background:#72e0ff;border-color:#72e0ff;font-weight:600}
    .tabshare{margin-left:auto}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,#0c1420,#0a1018);border:1px solid #1b2a40;border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:10px}
    .card h3{font-size:14px;margin:0;color:#e8f3ff;line-height:1.2;text-align:center}
    .meta{font-size:12px;color:#9fb3c8;text-align:center}

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ö‡∏ö myinstants */
    .pad{width:140px;height:140px;border-radius:999px;border:none;position:relative;display:grid;place-items:center;cursor:pointer;box-shadow:inset 0 -6px 0 rgba(0,0,0,.35), 0 6px 16px rgba(0,0,0,.35);}
    .pad.red{background:radial-gradient(35% 35% at 50% 30%, #ff8c8c, #ff3d3d 60%, #c11414 80%), linear-gradient(180deg,var(--pad-red2),var(--pad-red1));}
    .pad.green{background:radial-gradient(35% 35% at 50% 30%, #a7ffb7, #52e47a 60%, #138f32 80%), linear-gradient(180deg,var(--pad-green2),var(--pad-green1));}
    .pad.blue{background:radial-gradient(35% 35% at 50% 30%, #a6d8ff, #64b9ff 60%, #1766a8 80%), linear-gradient(180deg,var(--pad-blue2),var(--pad-blue1));}
    .pad:active{transform:translateY(1px)}
    .pad img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:999px;opacity:.9;mix-blend:screen;filter:saturate(130%)}
    .pad span.play{font-size:30px;text-shadow:0 2px 10px rgba(0,0,0,.6)}

    .pill{background:#0e1b2b;border:1px solid #1b2d47;color:#a7c1db;border-radius:999px;padding:4px 8px;font-size:12px}
    .vol{display:flex;align-items:center;gap:8px}
    .vol input{width:140px}
    .footer{opacity:.7;font-size:12px;margin-top:10px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0d1624;border:1px solid #1f2e4a;border-bottom-width:2px;border-radius:6px;padding:2px 6px}

    /* ‡πÅ‡∏û‡πÄ‡∏ô‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Editor) */
    .fab{position:fixed;right:16px;bottom:16px;z-index:50}
    .fab .btn{border-radius:999px;padding:14px 16px;font-size:16px}
    .panel{position:fixed;inset:auto 0 0 auto;right:0;top:0;height:100%;width:min(520px,100%);background:#0b121c;border-left:1px solid #1a2a44;box-shadow:-8px 0 18px rgba(0,0,0,.45);transform:translateX(100%);transition:.25s;z-index:40}
    .panel.open{transform:translateX(0)}
    .panel .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #152235}
    .panel .body{padding:12px 16px;display:grid;gap:12px;max-height:calc(100% - 110px);overflow:auto}
    .panel label{font-size:12px;color:#a9bed6}
    .panel input,.panel select,.panel textarea{width:100%;background:#0e1622;color:var(--text);border:1px solid #1e2c43;border-radius:10px;padding:8px 10px;font-size:14px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{font-size:12px;color:#9fb3c8}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1 style="flex:1">
          <img id="logo" class="logo" src="logo.png" alt="logo" onerror="this.style.display='none'"/>
          <span id="brandTitle">üîä Bento Soundpad</span>
        </h1>
        <div class="vol"><span>üîâ</span><input id="volume" type="range" min="0" max="1" step="0.01" value="1" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á"/></div>
        <div class="vol"><span>‚è©</span><input id="speed" type="range" min="0.6" max="1.25" step="0.05" value="1" aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß"/></div>
        <button id="stopAll" class="btn ghost" aria-label="‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Space)">‚èπÔ∏è Stop</button>
        <label class="switch"><input type="checkbox" id="cutMode" checked/> <span‡πÇ‡∏´‡∏°‡∏î Solo</span></label>
        <label class="switch"><input type="checkbox" id="haptic"/> <span>‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î</span></label>
        <label class="switch"><input type="checkbox" id="wakelock"/> <span>‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡∏±‡∏ö</span></label>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á / ‡∏Å‡∏î 1‚Äì9 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á" />
        <select id="categorySelect" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î"></select>
        <button id="share" class="btn" aria-label="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">üîó ‡πÅ‡∏ä‡∏£‡πå</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <img id="cover" class="cover" src="cover.jpg" alt="cover" onerror="this.style.display='none'"/>
    <div class="overlay"></div>
    <div class="title" id="heroTitle">Soundboard</div>
  </section>

  <main>
    <div class="tabs" id="tabs"></div>
    <div class="grid" id="grid" role="list"></div>
    <div class="footer wrap">Tips: <span class="kbd">1‚Äì9</span> ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô | <span class="kbd">Space</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ (‡∏õ‡∏¥‡∏î "‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Å‡πà‡∏≤")</div>
  </main>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
  <div class="fab"><button id="openEditor" class="btn primary" title="‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Editor)">üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>

  <!-- ‡πÅ‡∏û‡πÄ‡∏ô‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏™‡∏£‡πâ‡∏≤‡∏á manifest -->
  <aside id="editor" class="panel" aria-hidden="true">
    <div class="head">
      <strong>Editor: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏•‡πÇ‡∏Å‡πâ/‡∏õ‡∏Å/‡∏´‡∏°‡∏ß‡∏î/‡πÄ‡∏™‡∏µ‡∏¢‡∏á</strong>
      <div>
        <button id="exportJson" class="btn">üíæ Export sounds.json</button>
        <button id="closeEditor" class="btn ghost">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <div class="body">
      <div>
        <label>‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡∏¥‡πâ‡∏á</label>
        <div class="row2">
          <div>
            <label class="small">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏ß‡πá‡∏ö</label>
            <input id="brandInput" placeholder="Bento Soundpad"/>
          </div>
          <div>
            <label class="small">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å (accent)</label>
            <input id="accentInput" placeholder="#41d1ff"/>
          </div>
        </div>
        <div class="row2">
          <div>
            <label class="small">‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏û‡∏≤‡∏ò/URL ‡πÄ‡∏ä‡πà‡∏ô logo.png)</label>
            <input id="logoInput" placeholder="logo.png"/>
          </div>
          <div>
            <label class="small">‡∏†‡∏≤‡∏û‡∏õ‡∏Å (‡∏û‡∏≤‡∏ò/URL ‡πÄ‡∏ä‡πà‡∏ô cover.jpg)</label>
            <input id="coverInput" placeholder="cover.jpg"/>
          </div>
        </div>
      </div>

      <hr style="border-color:#152235;border-style:solid"/>

      <div>
        <label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</label>
        <div class="row2">
          <input id="newCatId" placeholder="‡πÄ‡∏ä‡πà‡∏ô memes"/>
          <input id="newCatName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÄ‡∏ä‡πà‡∏ô Memes"/>
        </div>
        <button id="addCat" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
      </div>

      <div>
        <label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</label>
        <div class="row2">
          <input id="soundName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏ä‡πà‡∏ô Bruh"/>
          <input id="soundFile" placeholder="‡πÑ‡∏ü‡∏•‡πå/URL ‡πÄ‡∏ä‡πà‡∏ô audio/memes/bruh.mp3"/>
        </div>
        <div class="row2">
          <input id="soundHotkey" placeholder="‡∏Æ‡∏≠‡∏ï‡∏Ñ‡∏µ‡∏¢‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"/>
          <select id="soundColor">
            <option value="red">‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á</option>
            <option value="green">‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</option>
            <option value="blue">‡∏õ‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
        </div>
        <input id="soundImage" placeholder="‡∏†‡∏≤‡∏û‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡πÄ‡∏ä‡πà‡∏ô images/bruh.png"/>
        <button id="addSound" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <div class="small">* ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏∂‡πâ‡∏ô GitHub ‡πÉ‡∏´‡πâ ‚Äî ‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏ó‡∏≥ <code>sounds.json</code> ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô repo ‡πÄ‡∏≠‡∏á</div>
      </div>

      <div>
        <label>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ sounds.json</label>
        <input id="importJson" type="file" accept="application/json"/>
      </div>
    </div>
  </aside>

  <script>
    // ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤/‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ======
    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á sounds.json ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
    // {
    //   "branding": { "title":"Bento Soundpad", "logo":"logo.png", "cover":"cover.jpg", "accent":"#41d1ff" },
    //   "categories": [
    //     {"id": "memes", "name": "Memes", "sounds": [
    //       {"name": "Bruh", "file": "audio/memes/bruh.mp3", "hotkey": "1", "color":"red", "image":"images/bruh.png"}
    //     ]}
    //   ]
    // }

    const SOUNDS_FALLBACK = {
      branding: { title:'Bento Soundpad', logo:'logo.png', cover:'cover.jpg', accent:'#41d1ff' },
      categories: [
        { id: 'memes', name: 'Memes', sounds: [
          { name: 'Bruh', file: 'audio/memes/bruh.mp3', hotkey: '1', color:'red' },
          { name: 'WompWomp', file: 'audio/memes/wompwomp.mp3', hotkey: '2', color:'red' }
        ]},
        { id: 'sfx', name: 'SFX', sounds: [
          { name: 'Whoosh', file: 'audio/sfx/whoosh.wav', hotkey: '3', color:'blue' },
          { name: 'Hit', file: 'audio/sfx/hit.wav', hotkey: '4', color:'green' }
        ]}
      ]
    };

    const els = {
      tabs: document.getElementById('tabs'),
      grid: document.getElementById('grid'),
      search: document.getElementById('search'),
      select: document.getElementById('categorySelect'),
      volume: document.getElementById('volume'),
      speed: document.getElementById('speed'),
      haptic: document.getElementById('haptic'),
      wakelock: document.getElementById('wakelock'),
      stopAll: document.getElementById('stopAll'),
      cutMode: document.getElementById('cutMode'),
      share: document.getElementById('share'),
      brandTitle: document.getElementById('brandTitle'),
      logo: document.getElementById('logo'),
      cover: document.getElementById('cover'),
      heroTitle: document.getElementById('heroTitle'),
      // editor
      openEditor: document.getElementById('openEditor'),
      editor: document.getElementById('editor'),
      closeEditor: document.getElementById('closeEditor'),
      exportJson: document.getElementById('exportJson'),
      brandInput: document.getElementById('brandInput'),
      accentInput: document.getElementById('accentInput'),
      logoInput: document.getElementById('logoInput'),
      coverInput: document.getElementById('coverInput'),
      newCatId: document.getElementById('newCatId'),
      newCatName: document.getElementById('newCatName'),
      addCat: document.getElementById('addCat'),
      soundName: document.getElementById('soundName'),
      soundFile: document.getElementById('soundFile'),
      soundHotkey: document.getElementById('soundHotkey'),
      soundColor: document.getElementById('soundColor'),
      soundImage: document.getElementById('soundImage'),
      addSound: document.getElementById('addSound'),
      importJson: document.getElementById('importJson'),
    };

    const state = {
      data: null,
      category: 'all',
      search: '',
      volume: 1,
      speed: 1,
      active: new Set(),
    };

    // ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ======
    async function loadData(){
      try{
        const res = await fetch('sounds.json', {cache:'no-store'});
        if(!res.ok) throw new Error('no manifest');
        return await res.json();
      }catch(e){
        console.warn('‡πÉ‡∏ä‡πâ SOUNDS_FALLBACK ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏´‡∏•‡∏î sounds.json ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', e);
        return SOUNDS_FALLBACK;
      }
    }

    // ====== UI helpers ======
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs||{})){
        if(k.startsWith('on') && typeof v === 'function') el[k.toLowerCase()] = v;
        else if(k==='dataset') for(const [dk,dv] of Object.entries(v)) el.dataset[dk] = dv;
        else if(v === true) el.setAttribute(k, '');
        else if(v !== false && v != null) el.setAttribute(k, v);
      }
      for(const c of children.flat()){
        if(c == null) continue;
        el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      }
      return el;
    }

    function setHash(){
      const params = new URLSearchParams();
      if(state.category && state.category !== 'all') params.set('cat', state.category);
      if(state.search) params.set('q', state.search);
      history.replaceState(null, '', params.toString() ? `?${params}` : location.pathname);
    }
    function readHash(){
      const p = new URLSearchParams(location.search);
      state.category = p.get('cat') || 'all';
      state.search = p.get('q') || '';
    }

    // ====== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ======
    function makeAudio(src){
      const a = new Audio(src);
      a.preload = 'none';
      a.volume = state.volume;
      a.playbackRate = state.speed;
      a.addEventListener('ended', () => state.active.delete(a));
      a.addEventListener('pause', () => state.active.delete(a));
      return a;
    }
    function playSound(src){
      if(els.cutMode.checked){ stopAll(); }
      if(els.haptic && els.haptic.checked && navigator.vibrate){ navigator.vibrate(15); }
      const a = makeAudio(src);
      state.active.add(a);
      a.play().catch(err=>{
        console.warn('‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
        alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô (autoplay policy)');
      });
    }
    function stopAll(){
      for(const a of Array.from(state.active)){
        try{ a.pause(); a.currentTime = 0; }catch{}
      }
      state.active.clear();
    }

    // ====== ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ======
    function applyBranding(){
      const b = state.data.branding || {};
      if(b.title){ els.brandTitle.textContent = b.title; els.heroTitle.textContent = b.title; }
      if(b.logo){ els.logo.src = b.logo; els.logo.style.display=''; }
      if(b.cover){ els.cover.src = b.cover; els.cover.style.display=''; }
      if(b.accent){ document.documentElement.style.setProperty('--acc', b.accent); }

      // ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô editor
      els.brandInput.value = b.title || '';
      els.accentInput.value = b.accent || '';
      els.logoInput.value = b.logo || '';
      els.coverInput.value = b.cover || '';
    }

    function renderTabs(){
      els.tabs.innerHTML = '';
      const all = h('button', {class:'tab '+(state.category==='all'?'active':''), onclick:()=>{state.category='all';setHash(); renderAll();}}, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
      const shareAll = h('button', {class:'tab tabshare btn ghost', onclick:()=>shareLink() }, 'üîó ‡πÅ‡∏ä‡∏£‡πå‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ô‡∏µ‡πâ');
      els.tabs.append(all, shareAll);
      state.data.categories.forEach(cat=>{
        const b = h('button', {class:'tab '+(state.category===cat.id?'active':''), onclick:()=>{state.category=cat.id;setHash();renderAll();}}, cat.name);
        const s = h('button', {class:'tab', onclick:()=>shareLink(cat.id)}, 'üîó');
        els.tabs.append(b,s);
      });
    }

    function renderSelect(){
      els.select.innerHTML = '';
      els.select.appendChild(h('option', {value:'all'}, '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'));
      state.data.categories.forEach(cat=> els.select.appendChild(h('option', {value:cat.id}, cat.name)) );
      els.select.value = state.category;
    }

    function filterSounds(){
      const q = state.search.trim().toLowerCase();
      const showCat = state.category;
      const list = [];
      for(const cat of state.data.categories){
        if(showCat !== 'all' && cat.id !== showCat) continue;
        for(const s of cat.sounds){
          const name = (s.name||'').toLowerCase();
          if(!q || name.includes(q)) list.push({...s, _cat: cat});
        }
      }
      return list;
    }

    function renderGrid(){
      els.grid.innerHTML = '';
      const sounds = filterSounds();
      sounds.forEach((s)=>{
        const pad = h('button', {class:'pad '+(s.color||'red'), onclick:()=>playSound(s.file), 'aria-label':`‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${s.name}`}, [
          s.image ? h('img', {class:'bg', src:s.image, alt:''}) : null,
          h('span', {class:'play'}, '‚ñ∂')
        ]);
        const shareBtn = h('button', {class:'btn ghost', onclick:()=>shareSound(s)}, 'üîó ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏µ‡πâ');
        const item = h('div', {class:'card', role:'listitem'},[
          pad,
          h('h3', {}, s.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'),
          $1
          (s.note ? h('div', {class:'meta'}, s.note) : null),
          h('div', {}, [shareBtn])
        ]);
        els.grid.appendChild(item);
      });
    }

    function renderAll(){
      applyBranding();
      renderTabs();
      renderSelect();
      els.search.value = state.search;
      renderGrid();
    }

    // ====== ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå ======
    function shareLink(catId){
      const params = new URLSearchParams(location.search);
      if(catId){ params.set('cat', catId); } else if(state.category && state.category!=='all'){ params.set('cat', state.category); } else { params.delete('cat'); }
      if(state.search){ params.set('q', state.search); } else { params.delete('q'); }
      const url = location.origin + location.pathname + (params.toString()?`?${params}`:'');
      navigator.clipboard.writeText(url).then(()=> alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'));
    }
    function shareSound(s){
      const params = new URLSearchParams();
      if(s._cat?.id) params.set('cat', s._cat.id);
      params.set('q', s.name);
      const url = location.origin + location.pathname + `?${params}`;
      navigator.clipboard.writeText(url).then(()=> alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'));
    }

    // ====== Editor ======
    function refreshEditorInputs(){
      const b = state.data.branding || {};
      els.brandInput.value = b.title || '';
      els.accentInput.value = b.accent || '';
      els.logoInput.value = b.logo || '';
      els.coverInput.value = b.cover || '';
    }

    function openEditor(){ els.editor.classList.add('open'); els.editor.setAttribute('aria-hidden','false'); refreshEditorInputs(); }
    function closeEditor(){ els.editor.classList.remove('open'); els.editor.setAttribute('aria-hidden','true'); }

    els.openEditor.addEventListener('click', openEditor);
    els.closeEditor.addEventListener('click', closeEditor);

    els.exportJson.addEventListener('click', ()=>{
      // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡∏¥‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ state
      state.data.branding = state.data.branding || {};
      state.data.branding.title = els.brandInput.value || state.data.branding.title;
      state.data.branding.accent = els.accentInput.value || state.data.branding.accent;
      state.data.branding.logo = els.logoInput.value || state.data.branding.logo;
      state.data.branding.cover = els.coverInput.value || state.data.branding.cover;

      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'sounds.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    els.addCat.addEventListener('click', ()=>{
      const id = els.newCatId.value.trim();
      const name = els.newCatName.value.trim() || id;
      if(!id){ alert('‡∏Å‡∏£‡∏≠‡∏Å id ‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô'); return; }
      if(state.data.categories.find(c=>c.id===id)){ alert('‡∏°‡∏µ id ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
      state.data.categories.push({id, name, sounds: []});
      els.newCatId.value = ''; els.newCatName.value = '';
      renderAll();
    });

    els.addSound.addEventListener('click', ()=>{
      const catId = state.category==='all' ? (state.data.categories[0]?.id) : state.category;
      if(!catId){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const cat = state.data.categories.find(c=>c.id===catId) || state.data.categories[0];
      const item = {
        name: els.soundName.value.trim() || 'Untitled',
        file: els.soundFile.value.trim(),
        hotkey: els.soundHotkey.value.trim() || undefined,
        color: els.soundColor.value,
        image: els.soundImage.value.trim() || undefined,
      };
      if(!item.file){ alert('‡πÉ‡∏™‡πà‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå/URL ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      cat.sounds.push(item);
      els.soundName.value = ''; els.soundFile.value = ''; els.soundHotkey.value=''; els.soundImage.value='';
      renderAll();
    });

    els.importJson.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const txt = await f.text();
      try{ state.data = JSON.parse(txt); }catch{ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
      renderAll();
    });

    // ====== ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ======
    els.search.addEventListener('input', (e)=>{ state.search = e.target.value; setHash(); renderGrid(); });
    els.select.addEventListener('change', (e)=>{ state.category = e.target.value; setHash(); renderAll(); });
    els.volume.addEventListener('input', (e)=>{ state.volume = +e.target.value; for(const a of state.active) a.volume = state.volume; });
    els.speed.addEventListener('input', (e)=>{ state.speed = +e.target.value; for(const a of state.active) a.playbackRate = state.speed; });
    els.stopAll.addEventListener('click', stopAll);
    els.share.addEventListener('click', ()=>{ setHash(); navigator.clipboard.writeText(location.href).then(()=> alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß')); });

    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){ e.preventDefault(); stopAll(); return; }
      // 1‚Äì9 ‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà n
      const idx = parseInt(e.key,10);
      if(idx>=1 && idx<=9){
        const items = els.grid.querySelectorAll('.card .pad');
        const btn = items[idx-1];
        if(btn){ btn.click(); }
      }
      if(e.key==='e' && (e.ctrlKey || e.metaKey)){ openEditor(); }
    });

    // ====== Wake Lock (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏î‡∏±‡∏ö) ======
    let wakeLockObj = null;
    async function updateWakeLock(){
      if(els.wakelock && els.wakelock.checked && 'wakeLock' in navigator){
        try{ wakeLockObj = await navigator.wakeLock.request('screen'); }
        catch(e){ console.warn('WakeLock error', e); alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Wake Lock'); els.wakelock.checked=false; }
      }else{
        if(wakeLockObj){ try{ await wakeLockObj.release(); }catch{} wakeLockObj = null; }
      }
    }
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible' && els.wakelock?.checked) updateWakeLock(); });
    if(els.wakelock) els.wakelock.addEventListener('change', updateWakeLock);

    $1
    (async function init(){
      readHash();
      state.data = await loadData();
      renderAll();
    })();
  </script>
</body>
</html>
