<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bubble Voice</title>
  <meta name="description" content="Bubble Voice ‚Äî ‡πÄ‡∏ß‡πá‡∏ö soundboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏Å‡∏î‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ó‡∏µ‡∏°‡∏Å‡∏î‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" />
  <style>
    :root{
      --bg:#0b0f14;--panel:#111823;--card:#0d1522;--acc:#41d1ff;--muted:#9fb3c8;--text:#e6f0ff;--ring:#2b6cb0;--sidebar:#0b121c;
      --pad-red1:#a80b0b;--pad-red2:#eb2c2c;--pad-green1:#0d6d26;--pad-green2:#35c75a;--pad-blue1:#114b7a;--pad-blue2:#2ea2ff;--range-track:#1c2a41;--range-thumb:#9fd9ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#0b0f14,#0e141d 60%,#0b0f14);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif}
    header{position:sticky;top:0;z-index:30;background:rgba(17,24,35,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #182335}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:20px;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:contain;background:#0e1622;border:1px solid #1e2c43}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    input[type="search"], .btn{background:#0e1622;color:var(--text);border:1px solid #1e2c43;border-radius:12px;padding:10px 12px;font-size:14px}
    input[type="search"]{flex:1;min-width:180px}
    .btn{cursor:pointer;user-select:none}
    .btn:hover{border-color:#294061}
    .btn.primary{background:linear-gradient(180deg,#133250,#0e1f34);border-color:#254467}
    .btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}
    .vol{display:flex;align-items:center;gap:6px}
    .vol input{width:200px;height:12px;accent-color:var(--acc);background:var(--range-track);border-radius:999px;outline:1px solid #21324d}
    /* range styling */
    input[type=range]{-webkit-appearance:none;appearance:none}
    input[type=range]::-webkit-slider-runnable-track{height:12px;background:var(--range-track);border-radius:999px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--acc);margin-top:-3px;box-shadow:0 0 0 2px #0b0f14}
    input[type=range]::-moz-range-track{height:12px;background:var(--range-track);border-radius:999px}
    input[type=range]::-moz-range-thumb{width:18px;height:18px;border:none;border-radius:50%;background:var(--acc)}

    main{max-width:1200px;margin:20px auto;padding:16px}
    .layout{display:grid;grid-template-columns:160px 1fr;gap:20px}
    .sidebar{background:var(--sidebar);border:1px solid #1a2a44;border-radius:14px;padding:12px;position:sticky;top:96px;height:fit-content;max-height:calc(100vh - 110px);overflow:auto}
    .catbtn{display:flex;align-items:center;gap:8px;width:100%;text-align:left;padding:10px 12px;border-radius:10px;border:1px solid #22314b;background:#0f1724;color:var(--text);cursor:pointer;margin-bottom:8px;font-size:14px}
    .catbtn.active{background:#72e0ff;color:#07131f;border-color:#72e0ff;font-weight:700}
    @media (max-width: 860px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:flex;gap:8px;overflow:auto;white-space:nowrap;position:static}
      .catbtn{display:inline-flex;width:auto}
    }

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;margin-top:12px}
    .card{background:linear-gradient(180deg,#0c1420,#0a1018);border:1px solid #1b2a40;border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:10px}
    .card h3{font-size:20px;margin:0;color:#e8f3ff;line-height:1.25;text-align:center}
    .meta{font-size:12px;color:#9fb3c8;text-align:center}

    .pad{width:140px;height:140px;border-radius:999px;border:none;position:relative;display:grid;place-items:center;cursor:pointer;box-shadow:inset 0 -6px 0 rgba(0,0,0,.35), 0 6px 16px rgba(0,0,0,.35);}
    .pad.red{background:radial-gradient(35% 35% at 50% 30%, #ff8c8c, #ff3d3d 60%, #c11414 80%), linear-gradient(180deg,var(--pad-red2),var(--pad-red1));}
    .pad.green{background:radial-gradient(35% 35% at 50% 30%, #a7ffb7, #52e47a 60%, #138f32 80%), linear-gradient(180deg,var(--pad-green2),var(--pad-green1));}
    .pad.blue{background:radial-gradient(35% 35% at 50% 30%, #a6d8ff, #64b9ff 60%, #1766a8 80%), linear-gradient(180deg,var(--pad-blue2),var(--pad-blue1));}
    .pad:active{transform:translateY(1px)}
    .pad img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:999px;opacity:.9;mix-blend:screen;filter:saturate(130%)}
    .pad span.play{font-size:30px;text-shadow:0 2px 10px rgba(0,0,0,.6)}

    .footer{opacity:.7;font-size:12px;margin-top:10px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0d1624;border:1px solid #1f2e4a;border-bottom-width:2px;border-radius:6px;padding:2px 6px}
  </style>
  <meta name="theme-color" content="#0b0f14">
  <link rel="manifest" href="manifest.webmanifest">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1 style="flex:1">
          <img id="logo" class="logo" src="logo.png" alt="logo" onerror="this.style.display='none'"/>
          <span id="brandTitle">üîä Bubble Voice</span>
        </h1>
        <div class="vol"><span>üîâ</span><input id="volume" type="range" min="0" max="1" step="0.01" value="1" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á"/></div>
        <div class="vol"><span>‚è©</span><input id="speed" type="range" min="0.6" max="1.25" step="0.05" value="1" aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß"/></div>
        <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á / ‡∏Å‡∏î 1‚Äì9 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á" />
        <button id="shareCat" class="btn primary" title="‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ">üîó ‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</button>
        <button id="installBtn" class="btn" title="‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ (Add to Home)" style="display:none">üì≤ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <aside class="sidebar" id="sidebar"></aside>
      <div class="content">
        <div class="grid" id="grid" role="list"></div>
        <div class="footer">Tips: <span class="kbd">1‚Äì9</span> ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô | <span class="kbd">Space</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÇ‡∏´‡∏°‡∏î Solo)</div>
      </div>
    </div>
  </main>

  <script>
    // ====== ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (fallback) ======
    const SOUNDS_FALLBACK = {
      branding: { title:'Bubble Voice', logo:'logo.png', cover:null, accent:'#41d1ff' },
      categories: [
        { id: 'kkm15', name: 'kkm15', sounds: [
          { name: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡∏π‡∏°', file: 'audio/zoom.mp3', hotkey: '1', color:'red' }
        ]}
      ]
    };

    const els = {
      sidebar: document.getElementById('sidebar'),
      grid: document.getElementById('grid'),
      search: document.getElementById('search'),
      volume: document.getElementById('volume'),
      speed: document.getElementById('speed'),
      brandTitle: document.getElementById('brandTitle'),
      logo: document.getElementById('logo'),
      shareCat: document.getElementById('shareCat'),
    };

    const state = {
      data: null,
      category: 'all',
      search: '',
      volume: 1,
      speed: 1,
      active: new Set(),
      solo: true,
    };

    // ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ======
    async function loadData(){
  try{
    const url = 'sounds.json?ts=' + Date.now();   // <‚Äî ‡∏Å‡∏±‡∏ô cache
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('no manifest');
    return await res.json();
  }catch(e){
    console.warn('‡πÉ‡∏ä‡πâ SOUNDS_FALLBACK ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏´‡∏•‡∏î sounds.json ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', e);
    return SOUNDS_FALLBACK;
  }
}


    // ====== Helpers ======
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs||{})){
        if(k.startsWith('on') && typeof v === 'function') el[k.toLowerCase()] = v;
        else if(k==='dataset') for(const [dk,dv] of Object.entries(v)) el.dataset[dk] = dv;
        else if(v === true) el.setAttribute(k, '');
        else if(v !== false && v != null) el.setAttribute(k, v);
      }
      for(const c of children.flat()){
        if(c == null) continue;
        el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      }
      return el;
    }

    function setHash(){
      const params = new URLSearchParams();
      if(state.category && state.category !== 'all') params.set('cat', state.category);
      if(state.search) params.set('q', state.search);
      history.replaceState(null, '', params.toString() ? `?${params}` : location.pathname);
    }
    function readHash(){
      const p = new URLSearchParams(location.search);
      state.category = p.get('cat') || 'all';
      state.search = p.get('q') || '';
    }

    // ====== ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ======
    function makeAudio(src){
      const a = new Audio(src);
      a.preload = 'none';
      a.volume = state.volume;
      a.playbackRate = state.speed;
      a.addEventListener('ended', () => state.active.delete(a));
      a.addEventListener('pause', () => state.active.delete(a));
      return a;
    }
    function playSound(src){
      if(state.solo){ stopAll(); }
      const a = makeAudio(src);
      state.active.add(a);
      a.play().catch(err=>{
        console.warn('‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err, 'src=', src);
        alert(`‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
${err?.name||'Error'}
‡πÑ‡∏ü‡∏•‡πå: ${src}
(‡∏≠‡∏≤‡∏à‡∏û‡∏≤‡∏ò‡∏ú‡∏¥‡∏î/‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å autoplay)`);
      });
    }
    function stopAll(){
      for(const a of Array.from(state.active)){
        try{ a.pause(); a.currentTime = 0; }catch{}
      }
      state.active.clear();
    }

    // ====== ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ======
    function applyBranding(){
    const b = state.data.branding || {};
    const title = b.title || 'Bubble Voice';
    els.brandTitle.textContent = `üîä ${title}`;
    if(b.logo){ els.logo.src = b.logo; els.logo.style.display=''; }
  }
      if(b.title){ els.brandTitle.textContent = `üîä ${b.title}`; }
      if(b.logo){ els.logo.src = b.logo; els.logo.style.display=''; }
    

    function renderSidebar(){
      els.sidebar.innerHTML='';
      const mk = (id,name)=>{
        const b = h('button',{class:'catbtn '+(state.category===id?'active':''),onclick:()=>{state.category=id;setHash();renderAll();}},name);
        els.sidebar.appendChild(b);
      };
      mk('all','‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
      state.data.categories.forEach(cat=> mk(cat.id, cat.name));
    }

    function filterSounds(){
      const q = state.search.trim().toLowerCase();
      const showCat = state.category;
      const list = [];
      for(const cat of state.data.categories){
        if(showCat !== 'all' && cat.id !== showCat) continue;
        for(const s of cat.sounds){
          const name = (s.name||'').toLowerCase();
          if(!q || name.includes(q)) list.push({...s, _cat: cat});
        }
      }
      return list;
    }

    function renderGrid(){
      els.grid.innerHTML = '';
      const sounds = filterSounds();
      sounds.forEach((s)=>{
        const pad = h('button', {class:'pad '+(s.color||'red'), onclick:()=>playSound(s.file), 'aria-label':`‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${s.name}`}, [
          s.image ? h('img', {class:'bg', src:s.image, alt:''}) : null,
          h('span', {class:'play'}, '‚ñ∂')
        ]);
        const item = h('div', {class:'card', role:'listitem'},[
          pad,
          h('h3', {}, s.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'),
          (s.note ? h('div', {class:'meta'}, s.note) : null)
        ]);
        els.grid.appendChild(item);
      });
    }

    function renderAll(){
      applyBranding();
      renderSidebar();
      els.search.value = state.search;
      renderGrid();
    }

    // ====== ‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ======
    function shareCurrentCategory(){
      const params = new URLSearchParams();
      if(state.category && state.category!=='all') params.set('cat', state.category);
      if(state.search) params.set('q', state.search);
      const url = location.origin + location.pathname + (params.toString()?`?${params}`:'');
      navigator.clipboard.writeText(url).then(()=> alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'));
    }

    // ====== ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå ======
    els.search.addEventListener('input', (e)=>{ state.search = e.target.value; setHash(); renderGrid(); });
    els.volume.addEventListener('input', (e)=>{ state.volume = +e.target.value; for(const a of state.active) a.volume = state.volume; });
    els.speed.addEventListener('input', (e)=>{ state.speed = +e.target.value; for(const a of state.active) a.playbackRate = state.speed; });
    els.shareCat.addEventListener('click', shareCurrentCategory);

    window.addEventListener('keydown',(e)=>{
      if(e.code === 'Space'){ e.preventDefault(); stopAll(); return; }
      const idx = parseInt(e.key,10);
      if(idx>=1 && idx<=9){
        const items = els.grid.querySelectorAll('.card .pad');
        const btn = items[idx-1];
        if(btn){ btn.click(); }
      }
    });

    // ====== PWA Install Button ======
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');
    function isiOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent); }
    function isInStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
    window.addEventListener('beforeinstallprompt',(e)=>{
      e.preventDefault();
      deferredPrompt = e;
      if(!isiOS() && !isInStandalone()) installBtn.style.display = '';
    });
    installBtn?.addEventListener('click', async ()=>{
      try{ installBtn.disabled = true; await deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display='none'; }
      catch{ installBtn.disabled = false; }
    });

    // iOS ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ú‡πà‡∏≤‡∏ô Share > Add to Home Screen
    if(isiOS() && !isInStandalone()){
      const tip = document.createElement('div');
      tip.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;background:#0e1622;border:1px solid #1e2c43;border-radius:12px;padding:10px 12px;font-size:13px;opacity:.95;z-index:60;';
      tip.innerHTML = 'üì≤ <b>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î:</b> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π <b>Share</b> ‡∏ö‡∏ô Safari ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>Add to Home Screen</b>'; 
      setTimeout(()=>document.body.appendChild(tip), 1200);
      tip.addEventListener('click',()=> tip.remove());
    }

    // ====== Service Worker ======
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(console.warn);
    }

    // ====== Start ======
    (async function init(){
      readHash();
      state.data = await loadData();
      renderAll();
    })();
  </script>
</body>
</html>
